name: Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  test:
    name: Smoke Test - Main Page
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Build application
        run: |
          echo "üèóÔ∏è Building application..."
          npm run build
        env:
          VITE_SUPABASE_URL: http://localhost
          VITE_SUPABASE_PUBLISHABLE_KEY: test-key
          VITE_SUPABASE_PROJECT_ID: test-project

      - name: Start preview server
        run: |
          echo "üöÄ Starting preview server..."
          npx serve -s dist -p 3000 &
          sleep 3
          curl -f http://localhost:3000 || exit 1

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run smoke test
        run: |
          echo "üß™ Running smoke test on built app..."
          npx playwright test tests/smoke-main-page.spec.cjs --project=chromium
        continue-on-error: false

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'  # Only deploy on push to main
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build application
        run: |
          echo "üèóÔ∏è Building production bundle..."
          npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
          VITE_SUPABASE_PROJECT_ID: ${{ secrets.VITE_SUPABASE_PROJECT_ID }}

      - name: Copy build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "dist/"
          target: "/opt/ando/"
          strip_components: 0

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /opt/ando

            echo "üìÇ Backup old build..."
            rm -rf dist.old

            echo "üîÑ Pulling latest docker config..."
            git pull origin main

            echo "üê≥ Restarting nginx..."
            docker compose restart nginx

            echo "‚è≥ Waiting for service..."
            sleep 5

            echo "üìä Verifying deployment..."
            docker compose ps nginx

            echo "‚úÖ Deployment complete!"

      - name: Verify deployment
        run: |
          echo "üîç Checking if site is accessible..."
          curl -f -s -o /dev/null -w "%{http_code}" https://andojv.com || echo "‚ö†Ô∏è Site check failed"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Run production smoke tests
        run: |
          echo "üî• Running critical smoke tests on production..."
          BASE_URL=http://83.166.246.253 npm run test:smoke-critical
        continue-on-error: false

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üåç Site: https://andojv.com"
          echo "üìä Smoke test passed"
          echo "üê≥ Docker containers running"
