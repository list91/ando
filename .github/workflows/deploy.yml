name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch: # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  test:
    name: Smoke Test - Main Page
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run smoke test
        run: |
          echo "ðŸ§ª Running smoke test for main shop page..."
          npx playwright test tests/smoke-main-page.spec.cjs --project=chromium
        continue-on-error: false

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Deploy via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null

          # Deploy
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            echo "ðŸ“¦ Starting deployment..."

            cd /opt/ando

            echo "ðŸ”„ Pulling latest code..."
            git pull origin main

            echo "ðŸ³ Building Docker containers with prod config..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml build frontend

            echo "ðŸš€ Restarting services..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

            echo "â³ Waiting for containers to start..."
            sleep 10

            echo "ðŸ“Š Verifying deployment..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps

            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f

            echo "âœ… Deployment complete!"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "ðŸ” Checking if site is accessible..."
          curl -f -s -o /dev/null -w "%{http_code}" https://andojv.com || echo "âš ï¸ Site check failed"

      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ðŸŒ Site: https://andojv.com"
          echo "ðŸ“Š Smoke test passed"
          echo "ðŸ³ Docker containers running"
